name: checks
on: [push]
env:
  PLAYDATE_SDK_VERSION: 1.11.0
  PLAYDATE_SDK_PATH: /Users/runner/Developer/PlaydateSDK
  LOCAL_BIN_DIR: /Users/runner/bin
jobs:
  build_test:
    runs-on: macos-11
    steps:
      - uses: actions/cache@v3
        id: deps-pdsdk
        with:
          path: |
            ${{env.PLAYDATE_SDK_PATH}}
            ${{env.LOCAL_BIN_DIR}}
          key: PlaydateSDK-${{env.PLAYDATE_SDK_VERSION}}
      - run: brew install tree && tree
      - run: wget https://download.panic.com/playdate_sdk/PlaydateSDK-${{env.PLAYDATE_SDK_VERSION}}.zip
        if: steps.deps-pdsdk.outputs.cache-hit != 'true'
      - run: unzip *.zip
        if: steps.deps-pdsdk.outputs.cache-hit != 'true'
      - run: sudo installer -pkg PlaydateSDK.pkg -target /
        if: steps.deps-pdsdk.outputs.cache-hit != 'true'
      - run: mkdir ${{env.LOCAL_BIN_DIR}} && cp -v /usr/local/playdate/gcc-arm-none-eabi*/bin/* ${{env.LOCAL_BIN_DIR}}
        if: steps.deps-pdsdk.outputs.cache-hit != 'true'
      - run: cp -v ${{env.LOCAL_BIN_DIR}}/* /usr/local/bin/
        if: steps.deps-pdsdk.outputs.cache-hit == 'true' 
      - run: brew install cmocka
      - uses: actions/checkout@v2
      - run: make
      - run: make test
